<!doctype html>
<html>
<head><meta charset="utf-8"><title>Admin Panel</title><meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>body{font-family:Inter,Arial;background:#071017;color:#e8f0f2;padding:20px}.card{background:#0b1720;padding:16px;border-radius:10px;margin-bottom:12px}</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>Maxy Monitor â€” Admin</h2>
  <div class="card">
    <form id="settingsForm">
      <label>Channel ID</label><br><input id="channel_id" name="channel_id"><br>
      <label>Command</label><br><input id="command" name="command" value="!ping"><br>
      <label>Test Type</label><br><select id="test_type" name="test_type"><option value="prefix">prefix</option><option value="mention">mention</option></select><br>
      <label>Interval (ms)</label><br><input id="interval_ms" name="interval_ms" value="15000"><br>
      <label>Timeout (ms)</label><br><input id="timeout_ms" name="timeout_ms" value="5000"><br>
      <label>Response match</label><br><input id="response_match" name="response_match" value="pong"><br>
      <label>Auto ping URL (optional)</label><br><input id="auto_ping_url" name="auto_ping_url" placeholder="https://..."><br>
      <label>Auto ping interval (s)</label><br><input id="auto_ping_interval_s" name="auto_ping_interval_s" value="300"><br><br>
      <button id="saveBtn" type="button">Save settings</button>
      <button id="saveRunBtn" type="button">Save & Run</button>
      <button id="runBtn" type="button">Run immediate</button>
    </form>
    <div id="runResult"></div>
  </div>

  <div class="card">
    <div>Override status</div>
    <button onclick="setOverride('maintenance')">Maintenance</button>
    <button onclick="setOverride('restarting')">Restarting</button>
    <button onclick="setOverride('updating')">Updating</button>
    <button onclick="setOverride('')">Auto</button>
    <div id="overrideRes"></div>
  </div>

  <div class="card">
    <div>Preview chart</div>
    <canvas id="panelChart" height="120"></canvas>
  </div>

<script>
async function fetchJson(url){ const r=await fetch(url); return r.ok? r.json() : null; }
async function prefill(){
  const s = await fetchJson('/get-settings');
  if(!s){ document.body.insertAdjacentHTML('afterbegin','<div style="color:#f00">Login required</div>'); return; }
  document.getElementById('channel_id').value = s.channel_id || '';
  document.getElementById('command').value = s.command || '!ping';
  document.getElementById('test_type').value = s.test_type || 'prefix';
  document.getElementById('interval_ms').value = s.interval_ms || 15000;
  document.getElementById('timeout_ms').value = s.timeout_ms || 5000;
  document.getElementById('response_match').value = s.response_match || 'pong';
  document.getElementById('auto_ping_url').value = s.auto_ping_url || '';
  document.getElementById('auto_ping_interval_s').value = s.auto_ping_interval_s || 300;
  const months = await fetchJson('/monthly.json');
  if(months){ drawPanelChart(months); }
}

document.getElementById('saveBtn').addEventListener('click', async ()=> {
  const body = new URLSearchParams(new FormData(document.getElementById('settingsForm')));
  await fetch('/set-test', { method:'POST', body });
  alert('Saved');
});

document.getElementById('saveRunBtn').addEventListener('click', async () => {
  const body = new URLSearchParams(new FormData(document.getElementById('settingsForm')));
  await fetch('/set-test', { method:'POST', body });
  const r = await fetch('/run-check', { method:'POST' }).then(r=>r.json());
  document.getElementById('runResult').textContent = r.ok? 'UP':'DOWN';
  prefill();
});

document.getElementById('runBtn').addEventListener('click', async () => {
  const r = await fetch('/run-check', { method:'POST' }).then(r=>r.json());
  document.getElementById('runResult').textContent = r.ok? 'UP':'DOWN';
  prefill();
});

async function setOverride(s){
  const body = new URLSearchParams(); body.append('status', s);
  const r = await fetch('/set-override', { method:'POST', body });
  const j = await r.json();
  document.getElementById('overrideRes').textContent = j.ok? 'ok':'error';
  prefill();
}

let panelChart=null;
function drawPanelChart(months){
  const ctx = document.getElementById('panelChart').getContext('2d');
  const labels = months.map(d=>d.day.slice(5));
  const data = months.map(d=>d.uptime);
  if(panelChart) panelChart.destroy();
  panelChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{data, borderColor:'#39d353', fill:true, backgroundColor:'rgba(57,211,83,0.08)'}] }, options:{scales:{y:{beginAtZero:true,max:100}}} });
}

prefill();
</script>
</body></html>
